$ ->

  # Index:

  # Setup: 10..81
  # YouTube player: 80..160
  # Adding timing to lines: 410
  # Fill-in-the blank: 570
  # Translations: 600

  formatTime = (time) ->
    time = Math.floor(time)
    if time <= 9 then formatted_time = "00:0" + time
    if 9 < time <= 59 then formatted_time = "00:" + time
    if 60 <= time < 540
      if time%60 <= 9 then formatted_time = "0" + Math.floor((time)/60) + ":0" + (time)%60
      if 9 < time%60 <= 59 then formatted_time = "0" + Math.floor((time)/60) + ":" + (time)%60
    if 540 <= time < 3600
      if time%60 <= 9 then formatted_time = Math.floor((time)/60) + ":0" + (time)%60
      if 9 < time%60 <= 59 then formatted_time = Math.floor((time)/60) + ":" + (time)%60
    formatted_time

  shortFormatTime = (time) ->
    time = Math.floor(time)
    if time <= 9 then formatted_time = ":0" + time
    if 9 < time <= 59 then formatted_time = ":" + time
    if 60 <= time < 540
      if time%60 <= 9 then formatted_time = Math.floor((time)/60) + ":0" + (time)%60
      if 9 < time%60 <= 59 then formatted_time = Math.floor((time)/60) + ":" + (time)%60
    if 540 <= time < 3600
      if time%60 <= 9 then formatted_time = Math.floor((time)/60) + ":0" + (time)%60
      if 9 < time%60 <= 59 then formatted_time = Math.floor((time)/60) + ":" + (time)%60
    formatted_time

  addSlashes = (str) ->
    return (str + '').replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0')

  youtube_id = $('#data').attr('data-youtube-id')
  window.video_id = parseInt($('#data').attr('data-video-id'))

  tag = document.createElement("script")
  tag.src = "https://www.youtube.com/iframe_api"
  firstScriptTag = document.getElementsByTagName("script")[0]
  firstScriptTag.parentNode.insertBefore tag, firstScriptTag

  window.section = 0 
  window.time = 0
  window.got_volume = false
  window.video_play_counter = 0
  window.autoscroll = true
  window.exercise = false
  window.adding_content = false
  window.line_being_timed_id = 0
  window.line_being_edited_id = 0
  window.editing_lines = false
  window.adding_times = false

  if $('.star').attr('id') == 'star-full'
    window.star_id = parseInt($('#star-full').attr('data-star-id'))

  # WE GOTTA HAVE A PLAYBACK SLIDER

  $('#settings').append("
    <div class='playback-left-label end-label'><div class='playback-left-label inner-label'></div></div>
      <div id='playback-slider'></div>
    <div class='playback-right-label end-label'><div class='playback-right-label inner-label'></div></div>
  ")

  playbackControls = (video_duration) ->
    $('.playback-left-label.inner-label').html(":00")
    $('.playback-right-label.inner-label').html("#{shortFormatTime(video_duration)}")
  
    $('#playback-slider').slider(
        min: 0,
        max: video_duration,
        value: window.time,
        step: 1
        stop: (event, ui) ->
          player.seekTo($('#playback-slider').slider("value"))
          window.sliding = false
        slide: (event, ui) ->
          window.sliding = true
          $('#playback-slider').children().html(shortFormatTime(ui.value))
      )

  window.onYouTubeIframeAPIReady = ->
    player = new YT.Player("new-video-box", {
      height: "315"
      width: "420"
      videoId: youtube_id
      playerVars: 
        {
        controls: 0
        cc_load_policy: 1
        wmode: "opaque"
        }
      events:
        onReady: onPlayerReady
        onStateChange: onPlayerStateChange })
    console.log "Checking for cc..." + player.getOptions().indexOf('cc')
    window.player = player

  onPlayerReady = (event) ->
    video_duration = window.player.getDuration()
    window.video_duration = video_duration
    window.half_duration = video_duration * .5
    playbackControls(video_duration)
    if window.loop_length == false
      straightPlaybackBehavior()
    event.target.playVideo()

  countVideoPlayTime = ->

    # IF PLAYER IS PLAYING, UPDATE THE PLAY COUNTER
    state = player.getPlayerState()
    if state == 1
      window.video_play_counter += 1
    if state == 0
      $('#watch-again').addClass('video-finished')
      $('#watch-again').html('<br><br><br><br><br><h3 class="link-style">Watch again?</class></h3>')
      $('iframe').remove()
      if window.video_play_counter + 10 > window.video_duration
        $.post("/update_playcount/#{window.playcount_id}", (data) ->
          new_playcount = data.data.play_count
          $('#video-play-counter').html(new_playcount)
        )
        window.video_play_counter = 0
      $('#watch-again').after('<div id="new-video-box"></div>')
    
    # UI RESPONDS AS VIDEO PLAYS
    exact_time = player.getCurrentTime()
    window.time = Math.floor(exact_time)

    if window.autoscroll == true
      if $("[data-time=#{window.time}]").length != 0
        if $('.translation-area').length > 0
          this_line = $(".line-container[data-time=#{window.time}]").eq(0)
        else if $('.transcript-area').length > 0 
          this_line = $(".transcript-line[data-time=#{window.time}]").eq(0)
        unless this_line.hasClass('highlighted')
          this_line.effect("highlight", { color: "#FFFF00" }, 4000)
          this_line.addClass("highlighted")
          $("#community-notes").scrollTo(this_line.prev().prev(), { duration : 250 } )

    # PLAYBACK SLIDER MOVES HERE
    unless window.sliding == true
      $('#playback-slider').slider("value", window.time)
      $('#playback-slider').children().html(shortFormatTime(window.time))

  counter = setInterval(countVideoPlayTime, 400)
  done = false

  onPlayerStateChange = (event) ->
    if event.data == YT.PlayerState.PAUSED
      exact_time = player.getCurrentTime()
      window.time = Math.round(exact_time)
      window.section = window.time / window.loop_length

  delayedShow = ->
    window.player.playVideo()
  window.setTimeout(delayedShow, 1000)

  $('#watch-again').livequery ->
    $(this).click ->
      onYouTubeIframeAPIReady()
      $('#watch-again').removeClass('video-finished')
      $('#watch-again').html('')

  # CHECK TO SEE IF A PLAYCOUNT EXISTS FOR THIS USER/VIDEO PAIR; IF NOT, CREATE ONE
  # CHECK TO SEE IF AN INTERPRETATION EXISTS FOR THIS USER/VIDEO PAIR; IF NOT, CREATE ONE

  if window.user_id isnt null
    $.post("/find_playcount/#{window.user_id}/#{window.video_id}", (data) ->
      if data.data is 'no-playcount'
        $.post("/new_playcount/#{window.user_id}/#{window.video_id}", (data) ->
          window.playcount_id = data.data.id
          window.playcount_value = data.data.play_count
          $('#video-play-counter').html(window.playcount_value)
        )
      else
        window.playcount_id = data.data.id
        window.playcount_value = data.data.play_count
        $('#video-play-counter').html(window.playcount_value)
    )
    $.post("/find_interp/#{window.user_id}/#{window.video_id}", (data) ->
      if data.data is 'no-interp'
        window.interp_id = 'none-yet'
      else
        window.interp_id = data.data.id
    )

  getInterpID = ->
    $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
      window.interp_id = data.data.id)
  
  $('#language-select').livequery ->
    $(this).autocomplete(
      source: (request, response) ->
        $.ajax(
          url: "/language_list?term=#{request.term}",
          type: "POST", 
          dataType: "json",
          success: (data) ->
            console.log data
            response($.map(data.data, (item) ->
              label: item.name,
              value: item.name
            ))
        )
      )

  $('.toggle-autoscroll').livequery ->
    $(this).click ->
      if window.autoscroll == true
        window.autoscroll = false
        $(this).html('autoscroll off')
      else
        window.autoscroll = true
        $(this).html('autoscroll')

  $('.tab').click -> 
    this_tab = $(this)
    if this_tab.hasClass('small')
      $('.big').removeClass('big').addClass('small')
      this_tab.addClass('big').removeClass('small')

  $('#new-content').click ->
    if window.adding_content == false
      $('.note-category').addClass('option')
      $('#editing').html("
        <div style='text-align: center;'>
          <h1 style=>&uarr;</h1>
          <br>
          <h3>What kind of content<br>would you like to add?</h2>
        </div>")
      $('#notes-container').hide()
      $(this).attr('style','right: -1px;')
      window.adding_content = true

  backFromEditing = ->
    $('#notes-container').show()
    $('.note-area').show()
    $('#editing').html('')
    $('.note-category').removeClass('option')
    $('#add-new-note').removeAttr('style')
    window.adding_content = false

  $('#all-content').click ->
    backFromEditing()
    $('.other-user-content').show()

  $('#just-your-content').livequery ->
    $(this).click -> 
      backFromEditing()
      $('.other-user-content').hide()
    
  $('#back-from-editing').livequery ->
    $(this).click ->
      backFromEditing()

  createFillExerciseSetup = ->
    $('#transcripts-list').html('')
    $.post('/find_transcripts', { 'video_id' : "#{window.video_id}" }, (data) ->
      transcripts = data.data
      number_of_transcripts = transcripts.length
      console.log number_of_transcripts
      if number_of_transcripts == 0
        $('#editing').html("
          <h3>Sorry...</h3>
          <br>
          <p>There needs to be a transcript of this video before you can create a translation.</p>
          <p>Why not add one? :)</p>
          <br><br>
          <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Back </div>
        ")
      else if number_of_transcripts == 1
        transcript_id = parseInt(transcripts[0].id)
        $.post('/find_lines', { 'transcript_id' : "#{transcript_id}" }, (data) ->
          lines = data.data
          if lines[2] isnt undefined and lines[1] isnt undefined
            transcript_html = "#{lines[0].lang1}<br>#{lines[1].lang1}<br>#{lines[2].lang1}...<br><br><br>"
          else if lines[1] isnt undefined
            transcript_html = "#{lines[0].lang1}<br>#{lines[1].lang1}<br><br><br>"
          else
            transcript_html = "#{lines[0].lang1}<br>"
          $('#editing').html("
            <h3>Use this transcript?</h3>
            <br>
            #{transcript_html}
            <div id='create-new-exercise' class='btn btn-primary btn-small rounded one-transcript' data-transcript-id=#{transcript_id}> Let's do it! </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Back </div>
            <br><br>
            <div id='notice-area'></div>
          ")
        )
      else if number_of_transcripts > 1
        $('#editing').html("
            <h3>Which of these transcripts should we use?</h3><br><br>
            <div id='transcripts-list'></div>
            <div id='create-new-exercise' class='btn btn-primary btn-small rounded'> Go </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Back </div>
          ")
        for transcript in transcripts
          window.t_id = transcript.id
          $.post('/find_lines', { 'transcript_id' : "#{transcript.id}" }, (data) ->
            lines = data.data
            this_transcript_html = "<div style='float:left;'><input type='radio' class='transcript-choice' data-transcript-id=#{window.t_id}></div>"
            this_transcript_html += "<div style='margin-left: 20px;'>#{lines[0].lang1}<br>#{lines[1].lang1}<br>#{lines[2].lang1}<br>...<br><br><br></div>"
            $('#transcripts-list').append(this_transcript_html)
          )
    )

  createTranslationSetup = ->
    $.post('/find_transcripts', { 'video_id' : "#{window.video_id}" }, (data) ->
      transcripts = data.data
      number_of_transcripts = data.data.length
      if number_of_transcripts == 0
        $('#editing').html("
          <h3>Sorry...</h3>
          <br>
          <p>There needs to be a transcript of this video before you can create a translation.</p>
          <p>Why not add one? :)</p>
          <br><br>
          <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Back </div>
        ")
      else if number_of_transcripts == 1
        window.transcript_id = parseInt(transcripts[0].id)
        $.post('/find_lines', { 'transcript_id' : "#{transcript_id}" }, (data) ->
          lines = data.data
          if lines[2] isnt undefined and lines[1] isnt undefined
            transcript_html = "#{lines[0].lang1}<br>#{lines[1].lang1}<br>#{lines[2].lang1}...<br><br><br>"
          else if lines[1] isnt undefined
            transcript_html = "#{lines[0].lang1}<br>#{lines[1].lang1}<br><br><br>"
          else
            transcript_html = "#{lines[0].lang1}<br>"
          $('#editing').html("
            <h3>Use this transcript?</h3>
            <br>
            #{transcript_html}
            <br>
            <div class='big-friendly'>Translate into: &nbsp; <input type='text' id='language-select' placeholder='Search language' style='width: 160px; position: relative; top: 4px;'></p>
            <br>
            <div id='create-new-translation' class='btn btn-primary btn-small rounded one-transcript'> Go </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Back </div>
            <br><br>
            <div id='notice-area'></div>
          ")
        )
      else if number_of_transcripts > 1
        $('#editing').html("
            <h3>Which of these transcripts should we use?</h3><br><br>
            <div id='transcripts-list'></div>
            <div id='create-new-translation' class='btn btn-primary btn-small rounded'> Go </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Back </div>
          ")
        for transcript in transcripts
          console.log transcript
          window.t_id = transcript.id
          $.post('/find_lines', { 'transcript_id' : "#{transcript.id}" }, (data) ->
            lines = data.data
            this_transcript_html = "<div style='float:left;'><input type='radio' class='transcript-choice' data-transcript-id=#{window.t_id}></div>"
            this_transcript_html += "<div style='margin-left: 20px;'>#{lines[0].lang1}<br>#{lines[1].lang1}<br>#{lines[2].lang1}<br>...<br><br><br></div>"
            $('#transcripts-list').append(this_transcript_html)
          )
    )

  $('.transcript-choice').livequery ->
    $(this).click ->
      window.transcript_id = parseInt($(this).attr('data-transcript-id'))
      console.log window.transcript_id
      $('.transcript-choice').prop('checked', false)
      $(this).prop('checked', true)

  $('.option').livequery ->
    $(this).click ->
      if $(this).hasClass('option')
        category = $(this).attr('id')
        if category == 'vocabulary'
          $('#editing').html("        
            <div id='vocab-list'></div>
            <span id='user-name'><h3>Add new vocabulary:</h3></span>
            <input type='text' id='word-input' style='width: 150px;'> 
            = <input type='text' id='definition-input' style='width: 150px;'> 
            <br><br>
            <div id='submit-new-vocab' class='btn btn-primary btn-small rounded'> Submit Vocab Word </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Done </div>
          ")
        if category == 'multiple-choice'
          $('#editing').html("
            <span id='user-name'><h3>Add multiple-choice question:</h3></span>
            <input type='text' id='question-title' placeholder='Question title' style='width: 300px;'>
            <br><br>
            <li> &nbsp; <input type='text' class='mc-option' style='width: 200px;' placeholder='Option'> </li>
            <div class='new-multiple-choice-option'>
                <li> 
                &nbsp; <input type='text' class='new-multiple-choice-option' style='width: 200px;' placeholder='Click to add option' disabled=''> 
              </li>
            </div><br>
            <div id='submit-new-multiple-choice' class='btn btn-primary btn-small rounded'> Submit </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Done </div>
          ")
        if category == 'discussion-question'
          $('#editing').html("
            <h3>Add new discussion question:</h3>
            <input type='text' id='discussion-question-text'>
            <br>
            <div id='submit-new-discussion-question' class='btn btn-primary btn-small rounded'> Submit </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Done </div>
          ")
        if category == 'transcript'
          $.post('/find_transcripts', { 'video_id' : "#{window.video_id}" }, (data) ->
            console.log data
            number_of_transcripts = data.data.length
            if number_of_transcripts == 0
              init = "No one\'s added a transcription yet!"
            else if number_of_transcripts == 1
              init = "There's already a transcription for this video – are you sure you want to add another one?"
            else if number_of_transcripts > 1
              init = "There are already #{number_of_transcripts} transcriptions for this video – are you sure you want to add another?"
            $('#editing').html("
              <p><i>#{init}</i></p>
              <h3>Add lyrics or transcript:</h3>
              <textarea id='lyrics-textbox' style='width: 400px; height: 160px;'></textarea>
              <li><i>Transcribe line-by-line or copy the lyrics from your files.</i></li>
              <li><i>If you want, after hitting 'submit' you can time the lines to the video.</i></li>
              <br>
              <div id='submit-new-transcript' class='btn btn-primary btn-small rounded'> Submit </div>
              <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Done </div>
              <br><br>
              <div id='notice-area'></div>
            ")
          )
        if category == 'translation'
          createTranslationSetup()
        if category == 'fill-exercise'
          createFillExerciseSetup()
        if category == 'links'
          $('#editing').html("
            <h3>Add a relevant link:</h3>
            <input type='text' id='url'>
            <h3>Text excerpt:</h3>
            <textarea id='excerpt'></textarea>
            <p class='big-friendly'>Page language: &nbsp; <input type='text' id='language-select' placeholder='Search language' style='width: 160px; position: relative; top: 4px;'></p>
            <br>
            <div id='submit-new-link' class='btn btn-primary btn-small rounded'> Submit </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Done </div>
          ")
        if category == 'tweets'
          $('#editing').html("
            <h3>Add a relevant tweet:</h3>
            <input type='text' id='url'>
            <br>
            <span class='tiny'><i>(Copy and paste the URL.)</i></span>
            <br><br>
            <div id='submit-new-tweet' class='btn btn-primary btn-small rounded'> Submit </div>
            <div id='back-from-editing' class='btn btn-primary btn-small rounded'> Done </div>
          ")
        $('#editing').append("
          <br><br>
          <div id='notice-area'></div>")

  hideOtherIcons = (id) ->
    $(".edit-line[data-line-id=#{id}]").addClass('quiet')
    $(".comment-line[data-line-id=#{id}]").addClass('quiet')
    $(".remove-line[data-line-id=#{id}]").addClass('quiet')
    $(".add-time-to-line[data-line-id=#{id}]").addClass('quiet')
  
  showOtherIcons = (id) ->
    $(".edit-line[data-line-id=#{id}]").removeClass('quiet')
    $(".comment-line[data-line-id=#{id}]").removeClass('quiet')
    $(".remove-line[data-line-id=#{id}]").removeClass('quiet')
    $(".add-time-to-line[data-line-id=#{id}]").removeClass('quiet')

  # # # Adding new vocab

  postNewWord = (word, definition) ->
    $.post('/new_word', { 'word' : { 'interpretation_id' : "#{window.interp_id}", 'video_id' : "#{window.video_id}", 'user_id' : "#{window.user_id}", 'text' : "#{word}" } }, (data) ->
      word_id = data.data.id
      $('#vocab-list').append("
        <li>#{word} = #{definition}
        </li>
        <br><br>
      ")
      $.post('/new_definition', { 'definition' : { 'word_id' : "#{word_id}", 'user_id' : "#{window.user_id}", 'text' : "#{definition}" } }, (data) ->
        definition_id = data.data.id
        if $('#current-user-definitions').length > 0
          $('#current-user-definitions').children(':first').after("<li><a href=#{'/definitions/' + definition_id}>#{word} = #{definition}</a>")
        else
          $('#note-container').prepend("<li><a href=#{'/definitions/' + definition_id}>#{word} = #{definition}</a>")
      )
    )
    $('#word-input').val('')
    $('#definition-input').val('')

  $('#submit-new-vocab').livequery ->
    $(this).click ->
      if window.user == 'logged-out'
        $('#notice-area').html("<p class='notice'><i>Please sign in to add a new vocabulary word.</i></p>")
      else
        word = $('#word-input').val()
        definition = $('#definition-input').val()
        if word isnt '' and definition isnt '' and (word isnt definition)
          $('#none-yet').remove()
          if window.interp_id == 'none-yet'
            $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
              window.interp_id = data.data.id
              postNewWord(word, definition)
              my_content_tab = "<div id='just-your-content' class='small tab'>Just yours<br><a href='/interpretations/#{data.data.id}' style='color:white;font-size:10px;position:relative;bottom:6px;'>(own page)</a></div>"
              $('#all-content').after(my_content_tab)
            )
          else
            postNewWord(word, definition)

  $('.submit-challenge-answer').livequery ->
    $(this).click ->
      challenge_id = parseInt($(this).attr('id').substring(17))
      console.log challenge_id
      $(".option-challenge-#{challenge_id}").each(->
        this_option = $(this)
        if this_option.is(":checked")
          option_id = parseInt(this_option.attr('id').substring(7))
          $.post('/new_option_vote', { 'option_vote' : { 'option_id' : "#{option_id}", 'user_id' : "#{window.user_id}" } }, (data) ->
            console.log data
            this_option.parent().addClass('blue')
          )
        )

  $('.new-multiple-choice-option').livequery ->
    $(this).click ->
      $(this).before("<li> &nbsp; <input type='text' class='mc-option' style='width: 200px;' placeholder='Option'> </li>")

  # # # Adding timing to lines

  $('.add-time-to-word').livequery ->
    $(this).click ->
      window.word_id = parseInt($(this).attr('id'))
      $('.ui-slider-handle').addClass('time-selector')

  $('.vocab-time-selector').livequery ->
    $(this).dblclick ->
      $.post("/add_time_to_word", { 'word_id' : "#{window.word_id}", 'time' : "#{window.time}" }, (data) ->
        updated_time = data.data.time
        console.log updated_time
        $("##{window.word_id}").html(formatTime(updated_time))
        $('.ui-slider-handle').removeClass('vocab-time-selector')
      )

  $('.line-timing').livequery ->
    $(this).click ->  
      window.player.seekTo($(this).attr('data-time'))

  $('.add-time-to-line').livequery ->
    $(this).click ->
      id = parseInt($(this).attr('data-line-id'))
      window.line_being_timed_id = id
      $('.ui-slider-handle').addClass('time-selector')
      $('.ui-slider-handle').addClass('time-selector-handle')
      $('.add-time-to-line').addClass('quiet')
      $(".line-timing[data-line-id=#{id}]").hide()
      $(".lang1[data-line-id=#{id}]").after("
        <p id='instructions' class='tiny' style='margin-top: 8px;'>
          <span>
            <i class='icon icon-time icon-2x orange-icon time-selector'></i>
            Double click the orange clock when the line begins...
          </span>
          <br>
          <span class='back-from-adding-timing-to-lines'>
            Or go back:
            <i class='icon icon-remove icon-2x orange-icon'></i>
          </span>
        </p>")
      $(".edit-line[data-line-id=#{id}]").addClass('quiet')
      $(".comment-line[data-line-id=#{id}]").addClass('quiet')
      $(".remove-line[data-line-id=#{id}]").addClass('quiet')

  $('.back-from-adding-timing-to-lines').livequery ->
    $(this).click ->
      $('.time-selector').removeClass('time-selector')
      $('.time-selector-handle').removeClass('time-selector-handle')
      $(".line-timing").show()
      $('.add-time-to-line').removeClass('quiet')
      $('#instructions').remove()
      window.line_being_timed_id = 0
      $(".edit-line").removeClass('quiet')
      $(".comment-line").removeClass('quiet')
      $(".remove-line").removeClass('quiet')
      
  $('.time-selector').livequery ->
    $(this).dblclick ->
      time = window.time
      $.post('/update_line', { 'line' : { 'id' : "#{window.line_being_timed_id}", 'time' : "#{time}" } }, (data) ->
        line = data.data
        $(".line-timing[data-line-id=#{line.id}]").html(formatTime(line.time)).show()
        $('.time-selector').removeClass('time-selector')
        $('.time-selector-handle').removeClass('time-selector-handle')
        $('.add-time-to-line').removeClass('quiet')
        $('#instructions').remove()
        window.line_being_timed_id = 0
        showOtherIcons(line.id)
        $(".line-timing[data-line-id=#{line.id}]").html(formattedTime(line.time))
      )

  # # # Editing transcript

  $('.edit-lines').livequery ->
    $(this).click -> 
      if window.editing_lines == false
        if window.line_being_edited_id == 0
          $('.edit-line').each(->
            $(this).removeClass('quiet'))
          $('.remove-line').each(->
            $(this).removeClass('quiet'))
          $('.comment-line').each(->
            $(this).removeClass('quiet'))
          $('.add-time-to-line').each(->
            $(this).removeClass('quiet'))
          $(this).html('done editing')
          window.editing_lines = true
      else
        $('.edit-line').each(->
            $(this).addClass('quiet'))
        $('.remove-line').each(->
            $(this).addClass('quiet'))
        $('.comment-line').each(->
            $(this).addClass('quiet'))
        $('.add-time-to-line').each(->
          $(this).addClass('quiet'))
        $(this).html('edit + add times')
        window.editing_lines = false

  $('.edit-line').livequery ->
    $(this).click -> 
      id = parseInt($(this).attr('data-line-id'))
      this_line = $(this).siblings(".lang1[data-line-id=#{id}]")
      text = $.trim(this_line.text())
      this_line.replaceWith("<input type='text' class='update-line-area' style='width: 300px;' data-line-id=#{id}>")
      $(".update-line-area[data-line-id=#{id}]").val(text)
      $(this).replaceWith("<i class='icon icon-ok blue-link update-line' data-line-id=#{id}></i>")
      $(".comment-line[data-line-id=#{id}]").addClass('quiet')
      $(".remove-line[data-line-id=#{id}]").addClass('quiet')
      $(".add-time-to-line[data-line-id=#{id}]").addClass('quiet')

  $('.update-line').livequery ->
    $(this).click ->
      id = parseInt($(this).attr('data-line-id'))
      this_line = $(".update-line-area[data-line-id=#{id}]")
      this_lang1 = this_line.val()
      this_button = $(this)
      $.post('/update_line', { 'line' : { 'lang1' : "#{this_lang1}" , 'id' : "#{id}" } }, (data) ->
        line = data.data
        console.log line
        this_button.replaceWith("<span class='edit-line blue-link tiny' data-line-id=#{line.id}> <i class='icon icon-pencil'></i> </span>")
        this_line.replaceWith("<span class='lang1' data-line-id=#{id}>#{line.lang1}<span>")
      )
      $(".comment-line[data-line-id=#{id}]").removeClass('quiet')
      $(".remove-line[data-line-id=#{id}]").removeClass('quiet')
      $(".add-time-to-line[data-line-id=#{id}]").removeClass('quiet')

  $('.comment-line').livequery ->
    $(this).click -> 
      id = parseInt($(this).attr('data-line-id'))
      comment_area = $(".line-comment-area[data-line-id=#{id}]")
      comment_area.html("<span class='line-comment-area' data-line-id=#{id}><br><span class='notice'>Your comment:</span> &nbsp; <input type='text' class='comment'>&nbsp;<i class='icon-ok blue-link submit-line-comment' data-line-id=#{id}></i><i class='icon-remove blue-link remove-line-comment-area' data-line-id=#{id}></i></span>")
      hideOtherIcons(id)

  $('.remove-line-comment-area').livequery ->
    $(this).click ->
      id = parseInt($(this).attr('data-line-id'))
      comment_area = $(".line-comment-area[data-line-id=#{id}]")
      comment_area.html('')
      showOtherIcons(id)

  $('.submit-line-comment').livequery ->
    $(this).click ->
      id = parseInt($(this).attr('data-line-id'))
      $(".line-comment-area[data-line-id=#{id}]").remove()
      hideOtherIcons(id)

  $('.remove-line').livequery ->
    $(this).click ->
      id = parseInt($(this).attr('data-line-id'))
      $("#dialog-confirm").dialog("open")
      $("#dialog-confirm").attr("data-line-id", "#{id}")

  $("#dialog-confirm").dialog(
      autoOpen: false,
      buttons:
        Delete: ->
          id = parseInt($(this).attr('data-line-id'))
          $.post('/destroy_line', { 'id' : "#{id}" }, (data) ->
            line_id = data.data.id
            $(".transcript-line[data-line-id=#{line_id}]").remove()
            $("#dialog-confirm").dialog("close")
          )
        Cancel: ->
          $(this).dialog("close")
    )

  # # # Creating Fill in the Blank exercises

  $('#create-new-exercise').livequery ->
    $(this).click -> 
      if window.user == 'logged-out'
        $('#notice-area').html("<p class='notice'><i>Please sign in to add a fill-in-the-blanks exercise.</i></p>")
      else
        if $(this).hasClass('one-transcript')
          window.transcript_id = parseInt($(this).attr('data-transcript-id'))
        if window.transcript_id isnt null
          $.post('/find_lines', { 'transcript_id' : "#{window.transcript_id}" }, (data) ->
            lines = data.data
            transcript_html = '<h3>Click on a word to blank it out.</h3>'
            transcript_html += '<span><div id="finalize-fill-exercise" class="btn btn-primary rounded">Create quiz</div>'
            transcript_html += '<div id="back-to-select-transcript-stage" class="btn btn-primary rounded">Back</div></span>'
            transcript_html += '<br><br><div id="exercise-transcript">'
            for line in lines
              transcript_html += "<div class='exercise-transcript-line rounded' data-line-id=#{line.id}>#{line.lang1}</div>"
            transcript_html += '</div>'
            $('#editing').html(transcript_html)
            $('.exercise-transcript-line').each(->
              $(this).lettering('words')
            )
          )

  $('#back-to-select-transcript-stage').livequery ->
    $(this).click ->
      createFillExerciseSetup()

  $('#finalize-fill-exercise').livequery ->
    $(this).click ->
      if window.fill_exercise_id isnt undefined
        $.post('/find_fill_exercise', { 'fill_exercise_id' : "#{window.fill_exercise_id}" }, (data) ->
          window.location.href = "/fill_in_the_blanks/#{data.data.slug}"
        )

  postNewMissingWord = (word_text, line_id) ->
    $.post('/new_missing_word', { 'missing_word' : { 'fill_exercise_id' : "#{window.fill_exercise_id}", 'line_id' : "#{line_id}", 'word_text' : "#{word_text}" } }, (data) ->
        line_id = data.data.line_id
        word_text = data.data.word_text
        this_line = $(".exercise-transcript-line[data-line-id=#{line_id}]")
        this_line.children().each(->
          if $(this).html() == word_text
            $(this).html("<input type='text' class='blank'>")
        )
      )

  postFirstMissingWord = (word_text, line_id) ->
    $.post('/new_fill_exercise', { 'fill_exercise' : { 'transcript_id' : "#{window.transcript_id}", 'video_id' : "#{window.video_id}", 'user_id' : "#{window.user_id}" } }, (data) ->
      window.fill_exercise_id = data.data.id
      postNewMissingWord(word_text, line_id)
    )

  $('[class^="word"]').livequery ->
    $(this).click ->
      word_text = $(this).text()
      line_id = $(this).parent().attr('data-line-id')
      unless word_text == ''
        if window.fill_exercise_id == undefined
          postFirstMissingWord(word_text, line_id)
        else
          postNewMissingWord(word_text, line_id)

  # # # Translations

  $('#create-new-translation').livequery ->
    $(this).click ->
      if window.user == 'logged-out'
        $('#notice-area').html("<p class='notice'><i>Please sign in to add a translation.</i></p>")
      else
        language = $('#language-select').val()
        if language isnt '' 
          $.post('/find_language', { 'language' : "#{language}" }, (data) ->
            console.log data
            window.language_id = data.data.id
            $.post('/new_translation', { 'translation' : { 'transcript_id' : "#{window.transcript_id}", 'video_id' : "#{window.video_id}", 'user_id' : "#{window.user_id}", 'language_id' : "#{window.language_id}" } }, (data) ->
              window.translation_id = data.data.id
              $('#editing').html("<div class='big-friendly'>Translate away!</div>")
              for line in $('.lang1')
                id = $(line).attr('data-line-id')
                time = $(line).attr('data-time')
                lang1 = $.trim($(line).text())
                translation_html = "<br><br>
                  <div class='line-container rounded' data-line-id=#{id} data-time=#{time}>
                    <div class='line-left-subcontainer rounded'>#{lang1}</div>
                    <div class='line-right-subcontainer rounded'>
                      <div class='translate-line-input-area' data-line-id=#{id}></div>
                      <div class='translate-line' data-line-id=#{id} style='color: blue;'>
                        <i class='icon icon-pencil'></i>
                      </div>
                    </div>
                  </div>"
                $('#editing').append(translation_html)
              $('#editing').append("<br><div id='all-done-translating' class='btn btn-primary rounded' data-translation-id=#{window.translation_id}>All done</div>")
             )
           )

  $('.translate-line').livequery ->
    $(this).click ->
      id = $(this).attr('data-line-id')
      window.line_being_translated = id
      translation_html = "<span><input type='text' data-line-id=#{id} style='width: 180px;'> &nbsp; <i class='submit-translation icon icon-ok blue' data-line-id=#{id}></i> <i class='back-from-translating-line icon icon-remove blue' data-line-id=#{id}></i></span>"
      $(".translate-line-input-area[data-line-id=#{id}]").html(translation_html)
      $(this).hide()

  $('.submit-translation').livequery ->
    $(this).click ->
      id = $(this).attr('data-line-id')
      lang2 = $("input[data-line-id=#{id}]").val()
      unless lang2 == ''
        $.post('/new_translated_line', { 'translated_line' : { 'line_id' : "#{id}", 'lang2' : "#{lang2}", 'translation_id' : "#{window.translation_id}" } }, (data) ->
          $(".translate-line-input-area[data-line-id=#{data.data.line_id}]").html("#{data.data.lang2}")
        )

  $('#all-done-translating').livequery ->
    $(this).click ->
      id = $(this).attr('data-translation-id')
      $.post('/find_translation', { 'id' : "#{id}" }, (data) ->
        slug = data.data.slug
        window.location.href = "/translations/#{slug}"
      )

  # # # New transcripts

  postNewLines = (transcript) ->
    window.lines = transcript.split('\n')
    you_added = '<p class="big-friendly">You added a transcript:<br>(<span class="edit-lines blue-link">edit + add times</span> / <span class="toggle-autoscroll blue-link">autoscroll</span>)</p>'
    if $('#current-user-lines').length > 0 then $('#current-user-lines').append(you_added)
    else $('#notes-container').append(you_added)
    $.post('/new_transcript', { 'transcript' : { 'user_id' : "#{window.user_id}", 'interpretation_id': "#{window.interp_id}", 'video_id' : "#{window.video_id}" } }, (data) ->
      transcript_id = data.data.id
      for line in window.lines
        if line isnt '' 
          $.post('/new_line', { 'line' : { 'transcript_id' : "#{transcript_id}", 'interpretation_id' : "#{window.interp_id}", 'video_id' : "#{window.video_id}", 'lang1' : "#{line}" } }, (data) ->
            line = data.data
            line_html = "<div class='transcript-line rounded' data-line-id=#{line.id} data-time=#{line.time}>"
            line_html += "<span class='edit-line blue-link quiet tiny' data-line-id=#{line.id} title='Edit line'> <i class='icon icon-pencil'></i></span>"
            line_html += "<span class='comment-line blue-link quiet tiny' data-line-id=#{line.id} title='Add comment to line'> <i class='icon icon-comment'></i></span>"
            line_html += "<span class='remove-line blue-link quiet tiny' data-line-id=#{line.id} title='Delete line'> <i class='icon icon-remove'></i></span>"
            line_html += "<span class='add-time-to-line blue-link quiet tiny' data-line-id=#{line.id} title='Add time to line'> <i class='icon icon-time'></i></span>"
            line_html += "&nbsp; <span class='lang1' data-line-id=#{line.id}>#{line.lang1}</span>"
            line_html += "<span class='line-comment-area' data-line-id=#{line.id}></span></div>"
            if $('#current-user-lines').length > 0
              $('#current-user-lines').children(':first').append(line_html)
            else
              $('#notes-container').append(line_html)
              $('#none-yet').remove()
            backFromEditing()
          )
      )

  $('#submit-new-transcript').livequery ->
    $(this).click ->
      if window.user == 'logged-out'
        $('#notice-area').html("<p class='notice'><i>Please sign in to add a new transcript.</i></p>")
      else
        transcript = $('#lyrics-textbox').val()
        if transcript isnt ''
          if window.interp_id == 'none-yet'
            $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
              window.interp_id = data.data.id
              $('#all-content').after("<div id='just-your-content' class='small tab'>Just yours<br><a href='/interpretations/#{data.data.id}' style='color:white;font-size:10px;position:relative;bottom:6px;'>(own page)</a></div>")
              postNewLines(transcript)
            )
          else
            postNewLines(transcript)
        else
          $('#notice-area').html("<p class='notice'>Transcript can't be blank.</p>")

  postNewLink = (url, excerpt, lang) -> 
    $.post('/new_link', { 'link' : { 'interpretation_id' : "#{window.interp_id}", 'url' : "#{url}", 'excerpt' : "#{excerpt}", 'user_id' : "#{window.user_id}", 'video_id' : "#{window.video_id}" }, 'lang' : "#{lang}" }, (data) -> 
      console.log data
      link_html = "<img height='25' src='http://g.etfv.co/#{data.data.url}' width='25' />" + "<strong><a href='#{data.data.url}'>#{data.data.url.split('/')[2]}</a></strong>" + "<p>#{data.data.excerpt}</p>"
      if $('#current-user-links').length > 0
        $('#current-user-links').children(':first').after(link_html)
      else
        $('#notes-container').prepend("
          <p style='font-size: 16px;'>You added a new link: </p>
          #{link_html}")
      $('#none-yet').remove()
      backFromEditing()
    )

  $('#submit-new-link').livequery ->
    $(this).click -> 
      if window.user == 'logged-out'
        $('#notice-area').html("<p style='color: #0f82f5;'><i>Please sign in to add a new link.</i></p>")
      else
        url = $('#url').val()
        excerpt = $('#excerpt').val()
        lang = $('#language-select').val()
        if window.interp_id == 'none-yet'
          $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
            window.interp_id = data.data.id
            postNewLink(url, excerpt, lang)
          )
        else
          postNewLink(url, excerpt, lang) 

  postNewTweet = (twitter_id, tweeter) ->
    $.post('/new_tweet', { 'tweet' : { 'interpretation_id' : "#{window.interp_id}", 'tweeter' : "#{tweeter}", 'twitter_id' : "#{twitter_id}", 'user_id' : "#{window.user_id}", 'video_id' : "#{window.video_id}" } }, (data) -> 
      tweeter = data.data.tweeter
      twitter_id = data.data.twitter_id
      url = 'https://twitter.com/' + tweeter + '/' + 'statuses' + '/' + twitter_id
      console.log url
      if $('#current-user-tweets').length > 0
        $('#current-user-tweets').children(':first').after("<blockquote class='twitter-tweet'><a href=#{url}></a></blockquote>
          <script async src='//platform.twitter.com/widgets.js' charset='utf-8'></script>")
      else
        $('#notes-container').prepend("<blockquote class='twitter-tweet'><a href=#{url}></a></blockquote>
          <script async src='//platform.twitter.com/widgets.js' charset='utf-8'></script>")
      $('#none-yet').remove()
      backFromEditing()
    )

  $('#submit-new-tweet').livequery ->
    $(this).click -> 
      if window.user == 'logged-out'
        $('#notice-area').html("<p style='color: #0f82f5;'><i>Please sign in to add a new tweet.</i></p>")
      else
        tweet_url = $('#url').val().split('/')
        tweeter = tweet_url[3]
        twitter_id = tweet_url[5]
        if window.interp_id == 'none-yet'
          $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
            window.interp_id = data.data.id
            postNewTweet(twitter_id, tweeter)
          )
        else
          postNewTweet(twitter_id, tweeter)

  $('.discussion-responses').livequery ->
    $(this).click ->
      id = parseInt($(this).attr('id').substr(10))
      window.location.href = "/discussion_questions/#{id}"

  $('.add-discussion-answer').livequery -> 
    $(this).click -> 
      id = parseInt($(this).attr('id').substr(11))
      if window.user == 'logged-out'
          $("#answer-area-#{id}").html("<br><p class='notice'><i>Please sign in to add your response.</i></p>")
        else
          $(this).remove()
          $("#responses-#{id}").remove()
          $("#answer-area-#{id}").html("
            <input id='discussion-response-#{id}' type='text'><div id='submit-discussion-response-#{id}'class='submit-discussion-response btn btn-primary btn-small rounded' style='margin-left: 20px;'>Add your answer</div>
          ")

  $('.submit-discussion-response').livequery ->
    $(this).click -> 
      id = parseInt($(this).attr('id').substr(27))
      response = $("#discussion-response-#{id}").val()
      unless response == ''
        $.post('/new_discussion_response', { 'discussion_response' : { 'response_text' : "#{response}", 'discussion_question_id' : "#{id}", 'user_id' : "#{window.user_id}" } }, (data) ->
          $("#answer-area-#{id}").html("
            <p><strong>Your answer:</strong> #{data.data.response_text}</p>
          ")
        )

  postNewDiscussionQuestion = (question_text) ->
    $.post('/new_discussion_question', { 'discussion_question' : { 'interpretation_id' : "#{window.interp_id}", 'question_text' : "#{question_text}", 'user_id' : "#{window.user_id}", 'video_id' : "#{window.video_id}" } }, (data) -> 
      console.log data
      discussion_question = data.data.question_text
      if $('#current-user-discussion-questions').length > 0
        $('#current-user-discussion-questions').children(':first').after(discussion_question)
      else
        $('#notes-container').prepend("
          <p style='font-size: 16px;'>You added a question: </p>
          #{discussion_question}
          <br><br>
        ")
      $('#none-yet').remove()
      backFromEditing()
    )

  $('#submit-new-discussion-question').livequery -> 
    $(this).click ->
      if window.user == 'logged-out'
        $('#notice-area').html("<p class='notice'><i>Please sign in to add a new discussion question.</i></p>")
      else
        question_text = $('#discussion-question-text').val()
        if window.interp_id == 'none-yet'
          $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
            window.interp_id = data.data.id
            postNewDiscussionQuestion(question_text)
          )
        else
          postNewDiscussionQuestion(question_text)

  postNewChallengeQuestion = (challenge, options) ->
    $.post('/new_challenge', { 'challenge' : { 'interpretation_id' : "#{window.interp_id}", 'video_id' : "#{window.video_id}", 'user_id' : "#{window.user_id}", 'question_text' : "#{challenge}" } }, (data) ->
      challenge_id = data.data.id
      console.log "challenge = #{data.data.question_text}"
      new_challenge = "<p id='user-added-challenge'>#{data.data.question_text}</p>"
      if $('#current-user-challenges').length > 0
        $('#current-user-challenges').children(':first').after(new_challenge)
      else
        $('#notes-container').prepend("
          <p style='font-size: 16px;'>You added a multiple-choice question: </p>
          #{new_challenge}
          <br>
        ")
      options.each(->
        $.post('/new_option', { 'option' : { 'challenge_id' : "#{challenge_id}", 'answer_text' : "#{$(this).val()}" } }, (data) ->
          console.log "option = #{data.data.answer_text}"
          $('#user-added-challenge').append("
              <p style='margin-left: 20px;'> <input type='checkbox' id='option-#{data.data.id}' class='option-challenge-#{challenge_id}'> #{data.data.answer_text} </p>
            ")
        )
      $('#editing').html('')
      $('#notes-container').show()
      )
    )

  $('#submit-new-multiple-choice').livequery ->
    $(this).click ->
      if window.user == 'logged-out'
        $('#notice-area').html("<p style='color: #0f82f5;'><i>Please sign in to add a new multiple-choice challenge.</i></p>")
      else
        challenge = $('#question-title').val()
        options = $('.mc-option')
        if window.interp_id == 'none-yet'
          $.post("/new_interp/#{window.user_id}/#{window.video_id}", (data) ->
            window.interp_id = data.data.id
            postNewChallengeQuestion(challenge, options)
          )
        else
          postNewChallengeQuestion(challenge, options)

  $('#add-tag').click ->
    $('#tag-area').hide()
    $('#add-tag-action-prompt').hide()
    $('#new-tag-area').html("
      <div style='float: left; width: 180px;'>
        <span>New tag:<span>
        <br>
        <input id='new-tag' type='text' style='width: 160px; height: 18px; margin-top: 4px;'>
        <br>
        <div id='submit-new-tag' class='btn btn-primary btn-small rounded'> Submit </div>
        <div id='back-from-tagging' class='btn btn-primary btn-small rounded'> Back </div>
      </div>
      <div id='tag-types' style='float: right; width: 180px;'>
        <div style='width: 180px; float: left;'>
          <span>Tag description:</span>
        </div>
        <div style='width: 85px; float: left;'>
          <span class='tiny'><input type='checkbox' id='language' class='tag-type'>&nbsp; Language</span>
          <span class='tiny'><input type='checkbox' id='style' class='tag-type'>&nbsp; Style</span>
        </div>
        <div style='width: 85px; float: right;'>
          <span class='tiny'><input type='checkbox' id='difficulty' class='tag-type'>&nbsp; Difficulty</span>
          <span class='tiny'><input type='checkbox' id='artist' class='tag-type'>&nbsp; Artist</span>
        </div>
      <br></div>")

  $('#back-from-tagging').livequery ->
    $(this).click ->
      $('#tag-area').show()
      $('#add-tag-action-prompt').show()
      $('#new-tag-area').html("")

  $('.tag-type').livequery ->
    $(this).click ->
      if $(this).is(':checked')
        console.log "already checked"
      $('.tag-type').each(->
        $(this).prop("checked", false)
      )
      $(this).prop("checked", true)

  $('#new-tag').livequery -> 
    $('#new-tag').autocomplete(
      source: (request, response) ->
        matches = $.map(availableTags, (tag) ->
          tag  if tag.toUpperCase().indexOf(request.term.toUpperCase()) is 0)
        response matches
      minLength: 0
    )

  $('#submit-new-tag').livequery ->
    $(this).click ->
      if window.user_id == null
        $('#new-tag').val('Please sign in first.')
      else
        new_tag = $('#new-tag').val()
        unless new_tag == '' or new_tag == 'Oops, enter a tag first.' or new_tag == 'Oops, select a tag description.'
          $("input:checkbox").each(->
            if $(this).is(":checked") then window.tag_type = $(this).attr('id')
          )
          unless window.tag_type == undefined
            $.post('/new_tag', { 'name' : "#{new_tag}", 'user_id' : "#{window.user_id}", 'video_id' : "#{window.video_id}", 'tag_type' : "#{window.tag_type}" }, (data) ->
              tag_category = $("##{window.tag_type + '-tags'}")
              console.log tag_category
              tag_url = "/tags/#{data.tag.id}"
              console.log tag_url
              if $.trim(tag_category.text()) == ''
                tag_category.html("
                  <span class='tiny'>#{capitalizeString(window.tag_type)}:</span> &nbsp;
                    <a href=" + tag_url + ">#{data.tag.name}</a>
                ")
                $('#no-tags-yet').remove()
              else
                tag_category.html($.trim(tag_category.html()))
                tag_category.append("<span>, <a href=" + tag_url + ">#{data.tag.name}</a></span>")
              $('#new-tag-area').html("")
              $('#tag-area').show()
              $('#add-tag-action-prompt').show()
            )
          else
            $('#new-tag').val('Select tag description?')
        else
          $('#new-tag').val('Oops, enter a tag first.')
          

  $('#done').livequery ->
    $(this).click -> 
      $('#user-input').html('')
      $('#community-notes').slideDown()

  $('#star-empty').livequery ->
    $(this).click ->
      $.post('/add_star', { 'star' : { 'user_id' : "#{window.user_id}", 'video_id' : "#{window.video_id}" } }, (data) ->
        window.star_id = data.data.id
        $('#star-empty').replaceWith("<i class='icon icon-star icon-2x star' id='star-full'> </i>")
      )

  $('#star-full').livequery ->
    $(this).click ->
      $.post('/remove_star', { 'star_id' : "#{window.star_id}" }, (data) ->
        $('#star-full').replaceWith("<i class='icon icon-star-empty icon-2x star' id='star-empty'> </i>")
      )

  $('#toggle-show-lines').click ->
    $('.short-line').each(->
      $(this).children().eq(0).removeClass('quiet')
      $(this).children().eq(1).removeClass('quiet')
    )

  $('.note-category').click ->
    if $(this).hasClass('active')
      $(this).effect("highlight", { color: 'yellow' }, 3000)
      unless $(this).attr('id') == 'all'
        $('.note-area').hide()
        category = $(this).attr('id')
        $(".#{category}-area").show()
      else 
        $('.note-area').show()
