player = null

$ ->

  tag = document.createElement("script")
  tag.src = "https://www.youtube.com/iframe_api"
  firstScriptTag = document.getElementsByTagName("script")[0]
  firstScriptTag.parentNode.insertBefore tag, firstScriptTag
  video_youtube_id = $('#video-id').data('youtube-id')

  window.onYouTubeIframeAPIReady = ->
    player = new YT.Player("show-video-box",
      height: "380"
      width: "630"
      videoId: video_youtube_id
      events:
        onReady: onPlayerReady
        onStateChange: onPlayerStateChange)
    window.player = player

  onPlayerReady = (event) ->
    event.target.playVideo()

  countVideoPlayTime = ->
    array_builder = ->
      arr = []
      lyrics = $(".lang2")
      jQuery.each lyrics, ->
        id = $(this).attr("id")
        arr.push id
      arr

    scroll = (array, time) ->
      time_div = 'line-' + time
      if array.indexOf(time_div) > -1
        $("#lyrics").scrollTo ('#' + time_div), 2000

    exact_time = player.getCurrentTime()
    time = Math.round(exact_time)
    arr = array_builder()
    do_scroll = scroll(arr, time)

  onPlayerStateChange = (event) ->
    if event.data is YT.PlayerState.PLAYING and not done
      setTimeout stopVideo, 6000
      done = true

  counter = setInterval(countVideoPlayTime, 1000)
  done = false

  # CONTROLS

  $("#lang1-and-lang2").parent().hide()

  $("#just-lang2").click ->
    $(".lang2").slideDown()
    $(".lang1").slideUp()
    $(".lang2").attr("class", "wide-lyrics-container lang2")
    $("#just-lang2").parent().hide()
    $("#lang1-and-lang2").parent().show()
    $("#just-lang1").parent().show()

  $("#lang1-and-lang2").click ->
    $(".lang1").slideDown()
    $(".lang2").slideDown()
    $(".lang1").attr("class", "narrow-lyrics-container lang1")
    $(".lang2").attr("class", "narrow-lyrics-container lang2")
    $("#lang1-and-lang2").parent().hide()
    $("#just-lang1").parent().show()
    $("#just-lang2").parent().show()

  $("#just-lang1").click ->
    $(".lang1").slideDown()
    $(".lang2").slideUp()
    $(".lang1").attr("class", "wide-lyrics-container lang1")
    $("#just-lang1").parent().hide()
    $("#lang1-and-lang2").parent().show()
    $("#just-lang2").parent().show()

  $('#black').click ->
    $('.lyrics').each(->
      $(this).attr('class','lyrics black'))

  $('#white').click ->
    $('.lyrics').each(->
      $(this).attr('class','lyrics white'))

  $('#sky').click ->
    $('.lyrics').each(->
      $(this).attr('class','lyrics sky'))

  $('#video-top').click ->
    $('#lyrics').attr('class','lyrics-box centerbox top')

  $('#video-bottom').click ->
    $('#lyrics').attr('class','lyrics-box centerbox bottom')

  $('#video-below').click ->
    $('#lyrics').attr('class','lyrics-box centerbox below')
